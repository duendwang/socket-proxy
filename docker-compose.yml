services:
  socket-proxy:
    image: lscr.io/linuxserver/socket-proxy:latest
    security_opt:
      - "no-new-privileges:true"
    expose:
      - 2375
      - 2376
    environment:
      - ALLOW_START=0 #optional
      - ALLOW_STOP=0 #optional
      - ALLOW_RESTARTS=0 #optional
      - AUTH=0 #optional
      - BUILD=0 #optional
      - COMMIT=0 #optional
      - CONFIGS=0 #optional
      - CONTAINERS=1 #optional
      - DISABLE_IPV6=0 #optional
      - DISTRIBUTION=0 #optional
      - EVENTS=1 #optional
      - EXEC=0 #optional
      - IMAGES=0 #optional
      - INFO=0 #optional
      - LOG_LEVEL=info #optional
      - NETWORKS=0 #optional
      - NODES=0 #optional
      - PING=1 #optional
      - PLUGINS=0 #optional
      - POST=0 #optional
      - SECRETS=0 #optional
      - SERVICES=0 #optional
      - SESSION=0 #optional
      - SWARM=0 #optional
      - SYSTEM=0 #optional
      - TASKS=0 #optional
      - VERSION=1 #optional
      - VOLUMES=0 #optional
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /run
    networks:
      socket-proxy:
      wireguard:
        aliases:
          - ${SOCKET_NETWORK_ALIAS:?missing SOCKET_NETWORK_ALIAS}
        ipv4_address: ${NETWORK_SUBNET:-10.13.13}.3
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    security_opt:
      - "no-new-privileges:true"
    cap_add:
      - NET_ADMIN
      - SYS_MODULE #optional
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
#      - SERVERURL=wireguard.domain.com #optional
      - SERVERPORT=51820 #optional
      - PEERS=2 #optional
      - PEERDNS=auto #optional
      - INTERNAL_SUBNET=${NETWORK_SUBNET:-10.13.13}.0 #optional
      - ALLOWEDIPS=${ALLOWED_IPS:-0.0.0.0/0} #optional
      - PERSISTENTKEEPALIVE_PEERS= #optional
      - LOG_CONFS=true #optional
    volumes:
      - ./wireshark-config:/config
      - /lib/modules:/lib/modules #optional
    ports:
      - 51820:51820/udp
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1
    restart: unless-stopped
    networks:
      wireguard:
        ipv4_address: ${NETWORK_SUBNET:-10.13.13}.2
networks:
  socket-proxy:
    name: socket-proxy
  wireguard:
    name: wireguard
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-10.13.13.0}.0/24
